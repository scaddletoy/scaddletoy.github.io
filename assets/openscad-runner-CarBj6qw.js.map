{"version":3,"file":"openscad-runner-CarBj6qw.js","sources":["../../src/services/simple-worker-pool/simple-worker-pool.ts","../../src/services/openscad-wasm-runner/openscad-runner.ts"],"sourcesContent":["export type WorkerStatus = 'idle' | 'busy' | 'cleanup' | 'error' | 'terminated';\n\nexport type WorkerPoolStatus = {\n  workers: { id: string; status: WorkerStatus }[];\n  taskQueueLength: number;\n};\n\nexport type WorkerPoolStatusListener = (status: WorkerPoolStatus) => void;\n\nexport type WorkerTask<T, R, P> = {\n  data: T;\n  onProgress?: (msg: P) => void;\n  resolve: (value: R) => void;\n  reject: (reason: any) => void;\n  abortController: AbortController;\n};\n\nexport class SimpleWorkerPool<T, R, P> {\n  private workerUrl: string | URL;\n  private size: number;\n  private workerOpts: WorkerOptions;\n  private workers: Worker[] = [];\n  private idleWorkers: Worker[] = [];\n  private taskQueue: WorkerTask<T, R, P>[] = [];\n  private workerTaskMap = new Map<Worker, WorkerTask<T, R, P>>();\n  private workerIds = new Map<Worker, string>();\n  private workerStatus = new Map<Worker, WorkerStatus>();\n  private statusListeners: WorkerPoolStatusListener[] = [];\n\n  constructor(workerUrl: string | URL, opts?: { size?: number }, workerOpts?: WorkerOptions) {\n    this.workerUrl = workerUrl;\n    this.workerOpts = workerOpts ?? {};\n    this.size = Math.max(Math.min(opts?.size || navigator.hardwareConcurrency - 2, 1), 3);\n    window.addEventListener('unload', () => {\n      this.dispose();\n    });\n    for (let i = 0; i < this.size; ++i) {\n      this.addWorker();\n    }\n  }\n\n  private generateRandomId(length = 6): string {\n    const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';\n    let result = '';\n    for (let i = 0; i < length; ++i) {\n      result += chars.charAt(Math.floor(Math.random() * chars.length));\n    }\n    return result;\n  }\n\n  private addWorker() {\n    const workerId: string = this.generateRandomId(2);\n    const worker = new Worker(this.workerUrl, { ...this.workerOpts, name: `worker-${workerId}` });\n    worker.onmessage = (e) => this.handleWorkerMessage(worker, e);\n    worker.onerror = (e) => this.handleWorkerError(worker, e);\n    this.workers.push(worker);\n    this.idleWorkers.push(worker);\n    this.workerIds.set(worker, workerId);\n    this.workerStatus.set(worker, 'idle');\n    worker.postMessage({ __workerId: workerId });\n    this.notifyStatus();\n  }\n\n  runTask(data: T, onProgress?: (msg: P) => void): { promise: Promise<R>; abort: () => void } {\n    const abortController = new AbortController();\n    let task: WorkerTask<T, R, P>;\n    const dataWithId = { ...data, __workerTaskId: this.generateRandomId() };\n    const promise = new Promise<R>((resolve, reject) => {\n      task = { data: dataWithId, onProgress, resolve, reject, abortController };\n      this.taskQueue.push(task);\n      this.schedule();\n      this.notifyStatus();\n    });\n    return {\n      promise,\n      abort: () => {\n        abortController.abort();\n        this.abortTask(task!);\n      },\n    };\n  }\n\n  private schedule() {\n    while (this.idleWorkers.length && this.taskQueue.length) {\n      const worker = this.idleWorkers.shift()!;\n      const task = this.taskQueue.shift()!;\n      this.workerTaskMap.set(worker, task);\n      this.workerStatus.set(worker, 'busy');\n      worker.postMessage(task.data);\n      task.abortController.signal.addEventListener('abort', () => {\n        this.terminateWorker(worker, task, 'aborted');\n      });\n    }\n    this.notifyStatus();\n  }\n\n  private handleWorkerMessage(worker: Worker, e: MessageEvent) {\n    const task = this.workerTaskMap.get(worker);\n    if (!task) return;\n    if (e.data && e.data.__workerResult) {\n      task.resolve(e.data.result);\n      this.workerStatus.set(worker, 'cleanup');\n      this.notifyStatus();\n    } else if (e.data && e.data.__workerFinishedTask) {\n      this.finishTask(worker);\n    } else {\n      task.onProgress?.(e.data);\n    }\n  }\n\n  private handleWorkerError(worker: Worker, e: ErrorEvent) {\n    const task = this.workerTaskMap.get(worker);\n    if (task) {\n      task.reject(e.error || e.message);\n      this.workerStatus.set(worker, 'error');\n      this.finishTask(worker);\n    }\n    this.notifyStatus();\n  }\n\n  private finishTask(worker: Worker) {\n    this.workerTaskMap.delete(worker);\n    this.idleWorkers.push(worker);\n    this.workerStatus.set(worker, 'idle');\n    this.schedule();\n    this.notifyStatus();\n  }\n\n  private abortTask(task: WorkerTask<any, any, any>) {\n    // Find the worker running this task\n    for (const [worker, t] of this.workerTaskMap.entries()) {\n      if (t === task) {\n        this.terminateWorker(worker, task, 'aborted');\n        break;\n      }\n    }\n    // If not running yet, remove from queue\n    const idx = this.taskQueue.indexOf(task);\n    if (idx !== -1) {\n      this.taskQueue.splice(idx, 1);\n      task.reject('aborted');\n    }\n    this.notifyStatus();\n  }\n\n  private terminateWorker(worker: Worker, task: WorkerTask<any, any, any>, reason: string) {\n    this.workerTaskMap.delete(worker);\n    this.workerStatus.set(worker, 'terminated');\n    worker.terminate();\n    // Replace with a new worker\n    this.workers = this.workers.filter((w) => w !== worker);\n    this.addWorker();\n    task.reject(reason);\n    this.schedule();\n    this.notifyStatus();\n  }\n\n  dispose() {\n    for (const worker of this.workers) {\n      worker.terminate();\n      this.workerStatus.set(worker, 'terminated');\n    }\n    this.workers = [];\n    this.idleWorkers = [];\n    this.taskQueue = [];\n    this.workerTaskMap.clear();\n    this.notifyStatus();\n  }\n\n  // --- Status API ---\n  getStatus(): WorkerPoolStatus {\n    return {\n      workers: this.workers.map((worker) => ({\n        id: this.workerIds.get(worker) || '',\n        status: this.workerStatus.get(worker) || 'terminated',\n      })),\n      taskQueueLength: this.taskQueue.length,\n    };\n  }\n\n  subscribeStatus(listener: WorkerPoolStatusListener) {\n    this.statusListeners.push(listener);\n    // Immediately notify with current status\n    listener(this.getStatus());\n    return () => {\n      this.statusListeners = this.statusListeners.filter((l) => l !== listener);\n    };\n  }\n\n  private notifyStatus() {\n    const status = this.getStatus();\n    for (const listener of this.statusListeners) {\n      listener(status);\n    }\n  }\n}\n","// Portions of this file are Copyright 2021 Google LLC, and licensed under GPL2+. See COPYING.\n\nimport { SimpleWorkerPool } from '../simple-worker-pool/simple-worker-pool.ts';\n\nexport type OpenSCADFile = {\n  path: string;\n  content: string;\n};\n\nexport type OpenSCADInvocation = {\n  taskName: string;\n  mountArchives: boolean;\n  files: OpenSCADFile[];\n  isPreview: boolean;\n  exportFormat: string;\n  vars?: { [name: string]: any };\n  features?: string[];\n  extraArgs?: string[];\n};\n\nexport type OpenSCADInvocationResult = {\n  exitCode?: number;\n  error?: string;\n  outputs?: [string, string][];\n  mergedOutputs: MergedOutputs;\n  elapsedMillis: number;\n};\n\nexport type MergedOutputs = { stdout?: string; stderr?: string; error?: string }[];\nexport type OpenSCADInvocationProgress = { stderr: string } | { stdout: string };\n\nexport const workerPool = new SimpleWorkerPool<\n  OpenSCADInvocation,\n  OpenSCADInvocationResult,\n  OpenSCADInvocationProgress\n>(new URL('./openscad-worker.ts', import.meta.url) + '?v=' + Date.now(), {}, { type: 'module' });\n\nexport function spawnOpenSCAD(\n  invocation: OpenSCADInvocation,\n  streamsCallback: (ps: OpenSCADInvocationProgress) => void,\n): Promise<OpenSCADInvocationResult> {\n  const { promise, abort } = workerPool.runTask(invocation, (msg) => {\n    streamsCallback(msg);\n  });\n  return promise;\n}\n"],"names":["SimpleWorkerPool","workerUrl","opts","workerOpts","i","length","chars","result","workerId","worker","data","onProgress","abortController","task","dataWithId","resolve","reject","e","t","idx","reason","w","listener","l","status","workerPool","spawnOpenSCAD","invocation","streamsCallback","promise","abort","msg"],"mappings":"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"}