import{a as n}from"./vars-Djpe79R3.js";class k{workerUrl;size;workerOpts;workers=[];idleWorkers=[];taskQueue=[];workerTaskMap=new Map;workerIds=new Map;workerStatus=new Map;statusListeners=[];constructor(t,s,e){this.workerUrl=t,this.workerOpts=e??{},this.size=Math.max(Math.min(s?.size||navigator.hardwareConcurrency-2,1),3),window.addEventListener("unload",()=>{this.dispose()});for(let r=0;r<this.size;++r)this.addWorker()}generateRandomId(t=6){const s="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let e="";for(let r=0;r<t;++r)e+=s.charAt(Math.floor(Math.random()*s.length));return e}addWorker(){const t=this.generateRandomId(2),s=new Worker(this.workerUrl,{...this.workerOpts,name:`worker-${t}`});s.onmessage=e=>this.handleWorkerMessage(s,e),s.onerror=e=>this.handleWorkerError(s,e),this.workers.push(s),this.idleWorkers.push(s),this.workerIds.set(s,t),this.workerStatus.set(s,"idle"),s.postMessage({__workerId:t}),this.notifyStatus()}runTask(t,s){const e=new AbortController;let r;const i={...t,__workerTaskId:this.generateRandomId()};return{promise:new Promise((o,h)=>{r={data:i,onProgress:s,resolve:o,reject:h,abortController:e},this.taskQueue.push(r),this.schedule(),this.notifyStatus()}),abort:()=>{e.abort(),this.abortTask(r)}}}schedule(){for(;this.idleWorkers.length&&this.taskQueue.length;){const t=this.idleWorkers.shift(),s=this.taskQueue.shift();this.workerTaskMap.set(t,s),this.workerStatus.set(t,"busy"),t.postMessage(s.data),s.abortController.signal.addEventListener("abort",()=>{this.terminateWorker(t,s,"aborted")})}this.notifyStatus()}handleWorkerMessage(t,s){const e=this.workerTaskMap.get(t);e&&(s.data&&s.data.__workerResult?(e.resolve(s.data.result),this.workerStatus.set(t,"cleanup"),this.notifyStatus()):s.data&&s.data.__workerFinishedTask?this.finishTask(t):e.onProgress?.(s.data))}handleWorkerError(t,s){const e=this.workerTaskMap.get(t);e&&(e.reject(s.error||s.message),this.workerStatus.set(t,"error"),this.finishTask(t)),this.notifyStatus()}finishTask(t){this.workerTaskMap.delete(t),this.idleWorkers.push(t),this.workerStatus.set(t,"idle"),this.schedule(),this.notifyStatus()}abortTask(t){for(const[e,r]of this.workerTaskMap.entries())if(r===t){this.terminateWorker(e,t,"aborted");break}const s=this.taskQueue.indexOf(t);s!==-1&&(this.taskQueue.splice(s,1),t.reject("aborted")),this.notifyStatus()}terminateWorker(t,s,e){this.workerTaskMap.delete(t),this.workerStatus.set(t,"terminated"),t.terminate(),this.workers=this.workers.filter(r=>r!==t),this.addWorker(),s.reject(e),this.schedule(),this.notifyStatus()}dispose(){for(const t of this.workers)t.terminate(),this.workerStatus.set(t,"terminated");this.workers=[],this.idleWorkers=[],this.taskQueue=[],this.workerTaskMap.clear(),this.notifyStatus()}getStatus(){return{workers:this.workers.map(t=>({id:this.workerIds.get(t)||"",status:this.workerStatus.get(t)||"terminated"})),taskQueueLength:this.taskQueue.length}}subscribeStatus(t){return this.statusListeners.push(t),t(this.getStatus()),()=>{this.statusListeners=this.statusListeners.filter(s=>s!==t)}}notifyStatus(){const t=this.getStatus();for(const s of this.statusListeners)s(t)}}const u=new k(new URL("/openscad-worker.ts",import.meta.url)+"?v="+n,{},{type:"module"});function w(a,t){const{promise:s,abort:e}=u.runTask(a,r=>{t(r)});return s}export{w as s,u as w};
