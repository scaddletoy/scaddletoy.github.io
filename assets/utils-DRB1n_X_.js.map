{"version":3,"file":"utils-DRB1n_X_.js","sources":["../../src/utils.ts"],"sourcesContent":["// Portions of this file are Copyright 2021 Google LLC, and licensed under GPL2+. See COPYING.\n\ndeclare const __DEV__: boolean;\n\nfunction logDev(...args: any[]) {\n  if (__DEV__) {\n    console.debug('[DEV]', ...args);\n  }\n}\n\nexport function logMethod<T extends (...args: any[]) => any>(fn: T, prefix?: string): T {\n  if (__DEV__) {\n    // eslint-disable-next-line @typescript-eslint/no-unsafe-function-type\n    function getParamNames(fn: Function): string[] {\n      const fnStr = fn.toString().replace(/\\/\\/.*$|\\/\\*[\\s\\S]*?\\*\\//gm, '');\n      // Match: async function name(args) or function name(args)\n      const result =\n        fnStr.match(/^(?:async\\s*)?function[^(]*\\(([^)]*)\\)/)\n        || fnStr.match(/^[\\s\\(]*\\(([^)]*)\\)\\s*=>/)\n        || fnStr.match(/^[\\s\\(]*([^\\s=]+)\\s*=>/);\n      if (!result) return [];\n      return result[1]\n        .split(',')\n        .map((param) => param.trim().replace(/=.*$/, '')) // Remove default values\n        .filter((param) => param);\n    }\n    function extractFileNameFromStack(stack: string): string | null {\n      // Match the last file in the stack (after the last @)\n      const match = stack.trim().match(/(.*)@.*\\/([^\\/?#:]+\\.ts)/);\n      return match ? match[2] + '#' + match[1] : null;\n    }\n\n    function extractCallSite(err: Error, lineIndex: number = 1): string {\n      if (err.stack) {\n        const stackLines = err.stack.split('\\n');\n        if (stackLines.length > lineIndex) {\n          return extractFileNameFromStack(stackLines[lineIndex]) || '';\n        }\n      }\n      return '';\n    }\n\n    const paramNames = getParamNames(fn);\n    const definitionSite = extractCallSite(new Error());\n    return ((...args: any[]) => {\n      const callSite = extractCallSite(new Error());\n      const argDict = Object.fromEntries(paramNames.map((name, i) => [name, args[i]]));\n      console.debug(`[DEV] ${definitionSite}${fn.name}() @ ${callSite}`, argDict);\n      return fn(...args);\n    }) as T;\n  }\n  return fn;\n}\n\nexport function mapObject(\n  o: any,\n  f: (key: string, value: any) => any,\n  ifPred: (key: string) => boolean,\n) {\n  const ret: any[] = [];\n  for (const key of Object.keys(o)) {\n    if (ifPred && !ifPred(key)) {\n      continue;\n    }\n    ret.push(f(key, o[key]));\n  }\n  return ret;\n}\n\ntype Killer = () => void;\nexport type AbortablePromise<T> = Promise<T> & { kill: Killer };\nexport function AbortablePromise<T>(\n  f: (resolve: (result: T) => void, reject: (error: any) => void) => Killer,\n): AbortablePromise<T> {\n  let kill: Killer;\n  const promise = new Promise<T>((res, rej) => {\n    kill = f(res, rej);\n  });\n  return Object.assign(promise, { kill: kill! });\n}\n\n// <T extends any[]>(...args: T)\nexport function turnIntoDelayableExecution<T extends any[], R>(\n  delay: number,\n  job: (...args: T) => AbortablePromise<R>,\n) {\n  let pendingId: number | null;\n  let runningJobKillSignal: (() => void) | null;\n  // return AbortablePromise<SyntaxCheckOutput>((res, rej) => {\n  //   (async () => {\n  //     try {\n  //       const result = await job;\n  //       // console.log(result);\n\n  //       let parameterSet: ParameterSet | undefined = undefined;\n  //       if (result.outputs && result.outputs.length == 1) {\n  //         let [[, content]] = result.outputs;\n  //         content = new TextDecoder().decode(content as any);\n  //         try {\n  //           parameterSet = JSON.parse(content)\n  //           // console.log('PARAMETER SET', JSON.stringify(parameterSet, null, 2))\n  //         } catch (e) {\n  //           console.error(`Error while parsing parameter set: ${e}\\n${content}`);\n  //         }\n  //       } else {\n  //         console.error('No output from runner!');\n  //       }\n\n  //       res({\n  //         ...processMergedOutputs(result.mergedOutputs, {shiftSourceLines: {\n  //           sourcePath: sources[0].path,\n  //           skipLines: 1,\n  //         }}),\n  //         parameterSet,\n  //       });\n  //     } catch (e) {\n  //       console.error(e);\n  //       rej(e);\n  //     }\n  //   })()\n  //   return () => job.kill();\n  // });\n  //return (...args: T) => async ({now, callback}: {now: boolean, callback: (result?: R, error?: any) => void}) => {\n  return (...args: T) =>\n    ({ now }: { now: boolean }) =>\n      AbortablePromise<R>((resolve, reject) => {\n        let abortablePromise: AbortablePromise<R> | undefined = undefined;\n        (async () => {\n          const doExecute = async () => {\n            if (runningJobKillSignal) {\n              runningJobKillSignal();\n              runningJobKillSignal = null;\n            }\n            abortablePromise = job(...args);\n            runningJobKillSignal = abortablePromise.kill;\n            try {\n              resolve(await abortablePromise);\n            } catch (e) {\n              reject(e);\n            } finally {\n              runningJobKillSignal = null;\n            }\n          };\n          if (pendingId) {\n            clearTimeout(pendingId);\n            pendingId = null;\n          }\n          if (now) {\n            doExecute();\n          } else {\n            pendingId = window.setTimeout(doExecute, delay);\n          }\n        })();\n        return () => abortablePromise?.kill();\n      });\n}\n\nexport function validateStringEnum<T extends string>(\n  s: T,\n  values: T[],\n  orElse: (s: string) => T = (s) => {\n    throw new Error(`Unexpected value: ${s} (valid values: ${values.join(', ')})`);\n  },\n): T {\n  return values.indexOf(s) < 0 ? orElse(s) : s;\n}\nexport const validateBoolean = (s: boolean, orElse: () => boolean = () => false) =>\n  typeof s === 'boolean' ? s : orElse();\nexport const validateString = (s: string, orElse: () => string = () => '') =>\n  s != null && typeof s === 'string' ? s : orElse();\nexport const validateArray = <T>(\n  a: Array<T>,\n  validateElement: (e: T) => T,\n  orElse: () => T[] = () => [],\n) => {\n  if (!(a instanceof Array)) return orElse();\n  return a.map(validateElement);\n};\n\nexport function formatBytes(bytes: number): string {\n  if (bytes === 0) return '0 B';\n  const k = 1024;\n  const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];\n  const i = Math.floor(Math.log(bytes) / Math.log(k));\n  return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];\n}\n\nexport function formatMillis(n: number) {\n  if (n < 1000) return `${Math.floor(n)}ms`;\n\n  return `${Math.floor(n / 100) / 10}sec`;\n}\n\nexport function formatDateString(s?: string) {\n  if (!s) return undefined;\n  return formatDate(new Date(s));\n}\n\nexport function formatDate(d: Date = new Date()) {\n  if (navigator.language == 'en-US') return d.toISOString().slice(0, 10);\n  return d.toLocaleDateString();\n}\n\nexport function formatDateTimeString(s?: string) {\n  if (!s) return undefined;\n  return formatDateTime(new Date(s));\n}\n\nexport function formatDateTime(d: Date = new Date()) {\n  return formatDate(d) + ' ' + d.toLocaleTimeString();\n}\n\n// In PWA mode, persist files in LocalStorage instead of the hash fragment.\nexport function isInStandaloneMode() {\n  return Boolean('standalone' in window.navigator && window.navigator.standalone);\n}\n\nexport function downloadUrl(url: string, filename: string) {\n  const link = document.createElement('a');\n  link.href = url;\n  link.setAttribute('download', filename);\n  document.body.appendChild(link);\n  link.click();\n  link.parentNode?.removeChild(link);\n}\n\n/**\n * Returns the value of a query parameter from the hash-based URL.\n * If the param is present without a value (e.g. ?readonly), returns ''.\n * If not present, returns null.\n */\nexport function getHashQueryParam(param: string): string | null {\n  const hash = window.location.hash;\n  const queryIndex = hash.indexOf('?');\n  if (queryIndex === -1) return null;\n  const queryString = hash.substring(queryIndex + 1);\n  const params = new URLSearchParams(queryString);\n  return params.has(param) ? params.get(param) : null;\n}\n\n/**\n * Basic sanitizer: escapes <, >, &, \", and ' characters.\n */\nexport function basicSanitize(input: string): string {\n  return input\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;');\n}\n\n/**\n * Sanitizes and linkifies #tags and @users in a description string.\n * Converts #tag to <a href=\"/tag/TAGNAME\">#tag</a> and @user to <a href=\"/user/USERNAME\">@user</a>.\n * TAGNAME and USERNAME are lowercased, alphanumeric, and minus only.\n * Preserves paragraph breaks by converting newlines to <br>.\n */\nexport function sanitizeAndLinkify(description: string | undefined): string {\n  if (!description) return '';\n  // Basic sanitize first\n  let safe = basicSanitize(description);\n  // Replace #tags with links\n  safe = safe.replace(/#([a-zA-Z0-9\\-]+)/g, (match, tag) => {\n    const cleanTag = tag.toLowerCase().replace(/[^a-z0-9\\-]/g, '');\n    return `<a href=\"#/tag/${cleanTag}\">#${cleanTag}</a>`;\n  });\n  // Replace @users with links\n  safe = safe.replace(/@([a-zA-Z0-9\\-]+)/g, (match, user) => {\n    const cleanUser = user.toLowerCase().replace(/[^a-z0-9\\-]/g, '');\n    return `<a href=\"#/user/${cleanUser}\">@${cleanUser}</a>`;\n  });\n  // Preserve paragraph breaks\n  safe = safe.replace(/\\r?\\n/g, '<br>');\n  return safe;\n}\n\nexport async function hashSha1(content: string) {\n  const encoder = new TextEncoder();\n  const data = encoder.encode(content);\n  const hashBuffer = await crypto.subtle.digest('SHA-1', data);\n  const hashArray = Array.from(new Uint8Array(hashBuffer));\n  return hashArray.map((byte) => byte.toString(16).padStart(2, '0')).join('');\n}\n"],"names":["logMethod","fn","prefix","mapObject","o","f","ifPred","ret","key","AbortablePromise","kill","promise","res","rej","turnIntoDelayableExecution","delay","job","pendingId","runningJobKillSignal","args","now","resolve","reject","abortablePromise","doExecute","e","formatBytes","bytes","k","sizes","i","formatDateString","s","formatDate","d","formatDateTime","getHashQueryParam","param","hash","queryIndex","queryString","params","basicSanitize","input","sanitizeAndLinkify","description","safe","match","tag","cleanTag","user","cleanUser","hashSha1","content","data","hashBuffer","byte"],"mappings":"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"}